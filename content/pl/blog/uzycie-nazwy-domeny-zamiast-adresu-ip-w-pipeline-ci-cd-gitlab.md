---
title: U≈ºycie nazwy domeny zamiast adresu IP w pipeline CI/CD GitLab
date: 2024-05-31T12:00:00+00:00
description: U≈ºycie nazwy domeny zamiast adresu IP w pipeline CI/CD GitLab
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: sysadmin
authorEmoji: üêß
pinned: false
asciinema: true
series:
- GitLab
categories:
- Taiko
- Gauge
- Node.js
- npm
- GitLab
cover:
    image: images/2024-thumbs/gitlab02.webp
---

**Oto tutorial wideo**

{{<youtube t6e31LmgJKs>}}

### Wprowadzenie

Aby u≈ºyƒá nazwy domeny zamiast adresu IP w pliku `.gitlab-ci.yml` w GitLab do klonowania repozytori√≥w, wykonaj poni≈ºsze kroki, aby odpowiednio skonfigurowaƒá sw√≥j system.

#### Przewodnik Krok po Kroku

##### Dodawanie Klucza SSH do Sekcji Kluczy SSH U≈ºytkownika w GitLab

Aby zapewniƒá bezpieczny i poprawny dostƒôp do repozytorium GitLab, wykonaj te kroki, aby usunƒÖƒá klucz publiczny ed25519 z sekcji kluczy wdro≈ºeniowych projektu i dodaƒá go do sekcji kluczy SSH u≈ºytkownika.

1. **Usu≈Ñ Klucz SSH z Kluczy Wdro≈ºeniowych:**

   - **Przejd≈∫ do Swojego Projektu:**
     1. Zaloguj siƒô do swojego instance GitLab.
     2. Przejd≈∫ do swojego projektu (np. `https://gitlab.sysadmin.homes/developers/taiko`).
   
   - **Uzyskaj Dostƒôp do Kluczy Wdro≈ºeniowych:**
     1. W lewym pasku nawigacyjnym przejd≈∫ do **Ustawienia** > **Repozytorium**.
     2. Przewi≈Ñ w d√≥≈Ç do sekcji **Klucze Wdro≈ºeniowe**.
   
   - **Usu≈Ñ Klucz Publiczny:**
     1. Znajd≈∫ klucz SSH (ed25519.pub), kt√≥ry chcesz usunƒÖƒá.
     2. Kliknij przycisk **Usu≈Ñ** obok klucza, aby usunƒÖƒá go z kluczy wdro≈ºeniowych.

2. **Dodaj Klucz SSH do Kluczy SSH U≈ºytkownika:**

   - **Uzyskaj Dostƒôp do Ustawie≈Ñ U≈ºytkownika:**
     1. Kliknij na sw√≥j awatar w prawym g√≥rnym rogu interfejsu GitLab.
     2. Wybierz **Ustawienia** z menu rozwijanego.
   
   - **Przejd≈∫ do Kluczy SSH:**
     1. W menu ustawie≈Ñ u≈ºytkownika kliknij na **Klucze SSH** w lewym pasku bocznym.
   
   - **Dodaj Klucz Publiczny:**
     1. Skopiuj zawarto≈õƒá swojego klucza `ed25519.pub`. Klucz ten mo≈ºna znale≈∫ƒá na swoim lokalnym komputerze, zazwyczaj w katalogu `~/.ssh/`.
       ```bash
       cat ~/.ssh/id_ed25519.pub
       ```
     2. Wklej skopiowany klucz do pola **Klucz**.
     3. Dodaj opisowy **Tytu≈Ç** dla klucza, aby ≈Çatwiej by≈Ço go zidentyfikowaƒá p√≥≈∫niej.
     4. Kliknij przycisk **Dodaj klucz**, aby zapisaƒá go.

3. **Zweryfikuj Klucz SSH:**

   Po dodaniu klucza SSH, zweryfikuj, czy zosta≈Ç on poprawnie dodany:

   - **Wy≈õwietl Listƒô Kluczy SSH:**
     1. W sekcji **Klucze SSH** w ustawieniach u≈ºytkownika upewnij siƒô, ≈ºe nowy klucz pojawia siƒô na li≈õcie.

UsuwajƒÖc klucz publiczny ed25519 z kluczy wdro≈ºeniowych projektu i dodajƒÖc go do sekcji kluczy SSH u≈ºytkownika GitLab, zwiƒôkszasz bezpiecze≈Ñstwo i zapewniasz, ≈ºe klucz jest powiƒÖzany z konkretnym u≈ºytkownikiem, zamiast byƒá dostƒôpny jako klucz wdro≈ºeniowy. Ta metoda jest bezpieczniejsza i daje lepszƒÖ kontrolƒô nad dostƒôpem do repozytori√≥w.

4. **Zainstaluj OpenSSL (je≈õli nie jest jeszcze zainstalowany):**

   Upewnij siƒô, ≈ºe `openssl` jest zainstalowany na twoim komputerze. Je≈õli nie, zainstaluj go za pomocƒÖ mened≈ºera pakiet√≥w swojej dystrybucji.

   ```bash
   sudo apt-get update
   sudo apt-get install openssl
   ```

5. **Pobierz Certyfikat:**

   U≈ºyj polecenia `openssl`, aby po≈ÇƒÖczyƒá siƒô z serwerem GitLab i pobraƒá certyfikat. Zamie≈Ñ `gitlab.sysadmin.homes` na domenƒô swojego serwera GitLab.

   ```bash
   echo -n | openssl s_client -connect gitlab.sysadmin.homes:443 -servername gitlab.sysadmin.homes | openssl x509 > gitlab.crt
   ```

   To polecenie utworzy plik o nazwie `gitlab.crt` w bie≈ºƒÖcym katalogu, zawierajƒÖcy certyfikat serwera.

6. **Zweryfikuj Certyfikat:**

   Zweryfikuj pobrany certyfikat za pomocƒÖ poni≈ºszego polecenia:

   ```bash
   openssl x509 -in gitlab.crt -text -noout
   ```

   To polecenie wydrukuje szczeg√≥≈Çy certyfikatu, umo≈ºliwiajƒÖc upewnienie siƒô, ≈ºe jest to prawid≈Çowy certyfikat.

7. **Skopiuj Certyfikat do Zaufanego Sklepu:**

   Przenie≈õ pobrany certyfikat do systemowego katalogu zaufanych certyfikat√≥w i zaktualizuj certyfikaty CA:

   ```bash
   sudo cp gitlab.crt /usr/local/share/ca-certificates/gitlab.crt
   sudo update-ca-certificates
   ```

8. **Przetestuj Po≈ÇƒÖczenie z Serwerem GitLab z GitLab Runner:**

   Z linii polece≈Ñ gitlab-runner, przetestuj dostƒôp SSH, aby upewniƒá siƒô, ≈ºe dzia≈Ça poprawnie:

   ```bash
    ssh -i ~/.ssh/id_ed25519 -T git@gitlab.sysadmin.homes
    ssh -T git@gitlab.sysadmin.homes
   ```

9. **Wyrejestruj Runnera:**

   Wyrejestruj runnera GitLab:

   ```bash
   sudo gitlab-runner unregister --all-runners
   ```

10. **Przejd≈∫ do Swojego Projektu:**
   - Zaloguj siƒô do swojego instance GitLab.
   - Przejd≈∫ do swojego projektu (np. `https://gitlab.sysadmin.homes/developers/taiko`).

11. **Uzyskaj Dostƒôp do Ustawie≈Ñ CI/CD:**
   - W lewym pasku nawigacyjnym przejd≈∫ do **Ustawienia** > **CI/CD**.
   - Przewi≈Ñ w d√≥≈Ç do sekcji **Runnery**.

12. **Usu≈Ñ Runnera GitLab:**
   - W sekcji **Runnery**, znajd≈∫ runnera, kt√≥rego chcesz usunƒÖƒá.
   - Kliknij przycisk **Edytuj** obok runnera, aby wy≈õwietliƒá jego szczeg√≥≈Çy.
   - Na dole strony szczeg√≥≈Ç√≥w runnera, kliknij przycisk **Usu≈Ñ**, aby usunƒÖƒá runnera z projektu.

13. **Dodaj Nowego Runnera:**
   - W sekcji **Dostƒôpne okre≈õlone runnery** zobaczysz przycisk **Dodaj Runnera**. Kliknij na niego.

14. **Wype≈Çnij Szczeg√≥≈Çy Runnera:**
   - Pojawi siƒô formularz, w kt√≥rym musisz podaƒá szczeg√≥≈Çy nowego runnera.
   - **Opis:** Wprowad≈∫ opis dla runnera (np. `docker-runner`).
   - **Tagi:** Dodaj tagi identyfikujƒÖce runnera (np. `docker`, `linux`).
   - **Uruchamiaj nieoznaczone zadania:** W≈ÇƒÖcz lub wy≈ÇƒÖcz tƒô opcjƒô w zale≈ºno≈õci od preferencji.
   - **Zablokowany:** Wybierz, czy zablokowaƒá runnera do bie≈ºƒÖcego projektu, czy nie.

15. **Wygeneruj i Skopiuj Token Rejestracyjny:**
   - Po wype≈Çnieniu szczeg√≥≈Ç√≥w, kliknij przycisk **Zarejestruj Runnera**.
   - Wygenerowany zostanie token rejestracyjny. Skopiuj ten token, poniewa≈º bƒôdzie potrzebny do rejestracji runnera.

16. **Zarejestruj ponownie Runnera:**

   Po zaufaniu certyfikatowi spr√≥buj ponownie zarejestrowaƒá GitLab runnera:

   ```bash
   sudo gitlab-runner register
   ```

17. **Ponownie zmodyfikuj `config.toml`:**

   Edytuj plik `/etc/gitlab-runner/config.toml` za pomocƒÖ poni≈ºszego polecenia:

   ```bash
   sudo vim /etc/gitlab-runner/config.toml
   ```

   Upewnij siƒô, ≈ºe wpis zawiera: `tags = ["docker"]`, `privileged = true`, oraz `services_limit = 1`.

   Konfiguracja powinna wyglƒÖdaƒá podobnie do tej:

   ```toml
   [[runners]]
     name = "docker"
     url = "https://gitlab.sysadmin.homes/"
     id = 2
     token = "glrt-TDN6NZ-WTx5Qy3QJZMUk"
     token_obtained_at = 2024-05-28T09:38:12Z
     token_expires_at = 0001-01-01T00:00:00Z
     executor = "docker"
     tags = ["docker"]
     [runners.custom_build_dir]
     [runners.cache]
       MaxUploadedArchiveSize = 0
       [runners.cache.s3]
       [runners.cache.gcs]
       [runners.cache.azure]
     [runners.docker]
       tls_verify = false
       image = "docker:latest"
       privileged = true
       disable_entrypoint_overwrite = false
       oom_kill_disable = false
       disable_cache = false
       volumes = ["/cache"]
       shm_size = 0
       network_mtu = 0
       services_limit = 1
   ```

##### Podsumowanie

Poprzez pobranie certyfikatu z serwera GitLab i dodanie go do zaufanych certyfikat√≥w systemowych, mo≈ºna rozwiƒÖzaƒá problem weryfikacji certyfikatu i pomy≈õlnie zarejestrowaƒá GitLab runnera.

##### Zmodyfikowany plik .gitlab-ci.yml

Zmodyfikowany plik `.gitlab-ci.yml` zawiera niezbƒôdne kroki, aby dodaƒá wpis do `/etc/hosts` oraz pobraƒá i zainstalowaƒá certyfikat SSL na Alpine Linux w sekcji `before_script`.

```yaml
variables:
  REPO_URL: 'git@gitlab.sysadmin.homes:developers/taiko.git'
  BRANCH: 'main'
  REPORT_PATH: '/workspace'
  REPORT_NAME: 'TAIKO_AUTOMATED_TESTS'
  DOCKER_IMAGE: "taiko"
  GIT_STRATEGY: clone
  TAIKO_SKIP_CHROMIUM_DOWNLOAD: "true"

stages:
  - clean
  - build_and_test
  - cleanup

before_script:
  # Sprawd≈∫, czy zainstalowany jest ssh-agent, je≈õli nie, zainstaluj openssh-client
  - 'which ssh-agent || ( apk update && apk add openssh-client )'
  # Uruchom ssh-agent w tle
  - eval $(ssh-agent -s)
  # Utw√≥rz katalog .ssh, je≈õli nie istnieje
  - mkdir -p ~/.ssh
  # Ustaw uprawnienia katalogu .ssh na 700
  - chmod 700 ~/.ssh
  # Utw√≥rz pusty plik known_hosts, je≈õli nie istnieje
  - touch ~/.ssh/known_hosts
  # Ustaw uprawnienia pliku known_hosts na 644
  - chmod 644 ~/.ssh/known_hosts
  # Dodaj klucz prywatny z zmiennej ≈õrodowiskowej do pliku i usu≈Ñ znaki powrotu karetki
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_ed25519
  # Ustaw uprawnienia pliku klucza prywatnego na 400
  - chmod 400 ~/.ssh/id_ed25519
  # Dodaj klucz prywatny do ssh-agent
  - ssh-add ~/.ssh/id_ed25519
  # Utw√≥rz plik konfiguracyjny SSH z ustawieniami dla hosta GitLab
  - echo -e "Host gitlab.sysadmin.homes\n\tUser git\n\tHostname gitlab.sysadmin.homes\n\tIdentityFile ~/.ssh/id_ed25519\n\tIdentitiesOnly yes\n\tStrictHostKeyChecking no" > ~/.ssh/config
  # Dodaj adres IP serwera GitLab do /etc/hosts
  - echo "10.10.0.119 gitlab.sysadmin.homes" >> /etc/hosts
  # Zainstaluj OpenSSL, je≈õli nie jest zainstalowany
  - apk add --no-cache openssl
  # Pobierz certyfikat SSL z serwera GitLab i zapisz go do pliku
  - echo -n | openssl s_client -connect gitlab.sysadmin.homes:443 -servername gitlab.sysadmin.homes | openssl x509 > gitlab.crt
  # Skopiuj pobrany certyfikat do katalogu z zaufanymi certyfikatami
  - cp gitlab.crt /usr/local/share/ca-certificates/gitlab.crt
  # Zaktualizuj listƒô zaufanych certyfikat√≥w
  - update-ca-certificates

build_and_test_awx:
  stage: build_and_test
  tags:
    - docker
  image: docker:latest
  services:
    - name: docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  script:
    - git clone --single-branch --branch $BRANCH $REPO_URL
    - docker build --build-arg NPM_USER="${NPM_USER}" --build-arg NPM_PASS="${NPM_PASS}" -t $DOCKER_IMAGE -f Dockerfile .
    - |
      docker run --rm -v ${CI_PROJECT_DIR}:/workspace $DOCKER_IMAGE bash -c '
        server_address="awx.sysadmin.homes"
        username="${AWX_USERNAME}"
        password="${AWX_PASSWORD}"
        rm -rf /workspace/node_modules
        rm -rf /lib/node_modules
        ln -s /usr/local/lib/node_modules/ /workspace/node_modules
        ln -s /usr/local/lib/node_modules/ /lib/node_modules
        rm -f *.tar downloaded//*
        rm -rf reports .gauge logs
        gauge run /workspace/specs/test-awx.spec
      '
    - if [ -d "${CI_PROJECT_DIR}/reports/" ]; then
        formattedDate=$(date +"%d_%m_%Y_%H_%M");
        filename="PASS_${REPORT_NAME}_${formattedDate}_AWX.tar";
        tar -cf ${filename} ${CI_PROJECT_DIR}/reports/ ${CI_PROJECT_DIR}/logs/;
        mv ${filename} ${CI_PROJECT_DIR}/;
      fi
    - docker system prune -af
    - docker volume prune -f
  artifacts:
    paths:
      - "${CI_PROJECT_DIR}/*.tar"

build_and_test_argocd:
  stage: build_and_test
  tags:
    - docker
  image: docker:latest
  services:
    - name: docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  script:
    - git clone --single-branch --branch $BRANCH $REPO_URL
    - docker build --build-arg NPM_USER="${NPM_USER}" --build-arg NPM_PASS="${NPM_PASS}" -t $DOCKER_IMAGE -f Dockerfile .
    - |
      docker run --rm -v ${CI_PROJECT_DIR}:/workspace $DOCKER_IMAGE bash -c '
        server_address="argocd.sysadmin.homes"
        username="${ARGOCD_USERNAME}"
        password="${ARGOCD_PASSWORD}"
        rm -rf /workspace/node_modules
        rm -rf /lib/node_modules
        ln -s /usr/local/lib/node_modules/ /workspace/node_modules
        ln -s /usr/local/lib/node_modules/ /lib/node_modules
        rm -f *.tar downloaded//*
        rm -rf reports .gauge logs
        gauge run /workspace/specs/test-argocd.spec
      '
    - if [ -d "${CI_PROJECT_DIR}/reports/" ]; then
        formattedDate=$(date +"%d_%m_%Y_%H_%M");
        filename="PASS_${REPORT_NAME}_${formattedDate}_ArgoCD.tar";
        tar -cf ${filename} ${CI_PROJECT_DIR}/reports/ ${CI_PROJECT_DIR}/logs/;
        mv ${filename} ${CI_PROJECT_DIR}/;
      fi
    - docker system prune -af
    - docker volume prune -f
  artifacts:
    paths:
      - "${CI_PROJECT_DIR}/*.tar"

clean_workspace:
  stage: cleanup
  tags:
    - docker
  script:
    - rm -rf $CI_PROJECT_DIR/*
```

W zaktualizowanym pliku `.gitlab-ci.yml`, sekcja `before_script` zawiera niezbƒôdne kroki, aby dodaƒá wpis do `/etc/hosts` oraz pobraƒá i zainstalowaƒá certyfikat SSL dla serwera GitLab na kontenerze opartym na Alpine. Zapewnia to

, ≈ºe GitLab Runner mo≈ºe poprawnie po≈ÇƒÖczyƒá siƒô z serwerem GitLab podczas wykonywania zadania. Dodanie [[ -f /.dockerenv ]] && echo -e ‚ÄúHost *StrictHostKeyChecking no‚Äù > ~/.ssh/config powinno wy≈ÇƒÖczyƒá sprawdzanie kluczy hosta dla po≈ÇƒÖcze≈Ñ SSH, co mo≈ºe pom√≥c rozwiƒÖzaƒá problem z dostƒôpem.